## 需求拆解
- 提升联网搜索质量：做“爬虫式 SERP 搜索”，优先支持百度，返回标题/URL/snippet，供后续 `browse_url` 精读。
- 信源可扩展：后续可接入 Bing/DDG/自建 searxng 等，多引擎降级与合并去重。
- 风险可控：默认关闭/显式授权/可追溯（日志/最近动作），并做限流/缓存/熔断与 SSRF 防护。
- 将单轮工具调用上限提升到 150。
- 把“日历提醒/通知/文件导入导出”做成可调用工具，同样遵循授权与审计策略。

## 现状要点（已定位代码落点）
- 工具 schema： [ToolsCatalog.kt](file:///Users/xushaoyang/Desktop/mumuchat/app/src/main/java/mumu/xsy/mumuchat/tools/ToolsCatalog.kt)
- 工具执行： [ChatViewModel.kt](file:///Users/xushaoyang/Desktop/mumuchat/app/src/main/java/mumu/xsy/mumuchat/ChatViewModel.kt) 的 `ToolEngine.register(...)`
- `exa_search` 固定 5 条结果且质量有限；`browse_url` 已有 `BrowseSafety` SSRF/内网拦截与重定向逐跳校验。
- 工具轮次上限：`MAX_TOOL_CALLS_PER_TURN = 12`（将提升到 150）。
- 已有“能力开关”模式：`enableLocalTools`、`enablePublicApis` 等；已有工具级统计/最近错误与 UI 展示（诊断面板）。

## 方案一：新增 SERP 搜索工具（爬虫 + 可扩展提供方）
### 1) 新工具：`serp_search`
- 入参
  - `query: string`（必填）
  - `engine: string`（可选：`auto|baidu|bing|duckduckgo|searxng`，默认 `auto`）
  - `limit: integer`（默认 8，最大 10）
  - `page: integer`（默认 1）
  - `site: string`（可选，内部转成 `site:xxx`）
  - `resolve_redirects: boolean`（可选，默认 false；true 时仅解析前 N 条的跳转最终 URL）
- 出参（统一结构，便于 agent 精准选链接）
  - `results: [{rank,title,url,display_url?,snippet,engine}]`
  - `meta: {engine, count, latency_ms, cached?, downgraded_from?}`

### 2) Provider 架构（便于扩展多引擎）
- 新增 `tools/search` 包：
  - `SerpProvider` 接口（`id` + `search(...)`）
  - `SerpItem/SerpResponse` 数据结构
  - `SerpSearchService`：负责 `auto` 路由、captcha/blocked 识别、降级、去重、统一错误码
- 复用现有 `RemoteApiClient`（缓存/限流/熔断）：
  - 以 provider 级别 id（如 `serp_baidu`）做限流与熔断 key
  - 以 `cacheKey=provider+query+page+limit` 做短 TTL 缓存（默认 3–5 分钟）

### 3) Baidu SERP（best-effort 爬虫）
- 请求：`https://www.baidu.com/s?wd=<encoded>&rn=<limit>&pn=<offset>`
- Header：`User-Agent: MuMuChat/2.1` + 合理 `Accept-Language`
- 解析：用 Jsoup 从 `#content_left` 抽取标题、摘要、展示链接；URL 允许返回 `baidu.com/link?...`（后续 `browse_url` 会逐跳校验并抓正文）
- 反爬识别：检测“安全验证/captcha”等特征，返回 `toolErr(code="captcha")`；`engine=auto` 自动降级到下一引擎。

### 4) 第二信源（分阶段）
- Phase 1：先交付 `baidu` +（二选一）`duckduckgo` HTML 或 `searxng` JSON
- Phase 2：补 `bing`，并支持 `serp_search_multi`（一次搜多个引擎合并去重）

## 方案二：系统能力工具（日历/通知/文件导入导出）= 默认关闭 + UI 授权 + 可追溯
### 1) 授权与“每次动作可追踪”通用机制
- 新增通用“用户确认通道”（UI 弹窗）
  - ViewModel 增加 `pendingAction` 状态与 `CompletableDeferred<Boolean>`
  - 工具 handler 在执行敏感动作前 `requestUserApproval(action)` 并 suspend 等待用户点击；超时/拒绝返回 `toolErr(code="user_denied"/"timeout")`
- 新增“最近动作”审计列表
  - 记录：工具名、参数摘要、结果、时间、是否用户确认、关联会话/消息 id（可选）
  - UI：在设置页新增“最近动作”面板，可清空
  - 同时复用现有 tool metrics（次数/错误/耗时）

### 2) 日历工具（Calendar）
- 计划提供工具：
  - `calendar_create_event(title, start, end, location?, notes?, remind_minutes?)`
  - `calendar_list_events(range_start, range_end, limit?)`
  - `calendar_delete_event(event_id)`（可选）
- 权限策略：默认关闭；开启后每次动作仍弹确认；按需申请 Android 日历读写权限。

### 3) 通知/提醒工具（Notifications）
- 计划提供工具：
  - `notify_schedule(title, text, at_timestamp, channel?)`
  - `notify_cancel(notification_id)`
- 权限策略：默认关闭；Android 13+ 需要通知权限；每次调度需确认；在“最近动作”可追溯。

### 4) 文件导入导出（SAF）
- 计划提供工具：
  - `file_export_session(session_id, format)`：基于现有 `export_session` 结果，用 SAF 让用户选择保存位置（用户可见、可撤销）
  - `file_import_session()`：通过 SAF 选择文件并导入（格式先支持 app 自己导出的 JSON/Markdown 之一）
  - `file_export_notes` / `file_import_notes`（可选）
- 权限策略：默认关闭；每次导入/导出都需要用户在系统选择器中确认；动作记录到“最近动作”。

## 公益 API 端点整合（按“可稳定直连”原则）
- 继续保留并优先使用已集成的：`60s.viki.moe` / `60s-api.114128.xyz` / TenAPI。
- 新增候选（按你提供的列表里“无需 key、可直连”的）：
  - `vvhan 60s`、`qqsuu 60s`、`770a 60s`：作为 `get_daily_brief` 的 `source` 扩展（主要用于图片直链）。
- 明确剔除/降级：你给的 `api.03c3.cn/zb` 目前返回 404（不纳入默认端点，除非后续恢复或替换域名）。
- 对所有新增端点：统一走 `PublicApiRegistry + RemoteApiClient`（缓存/限流/熔断）并在 UI 开关里细分提供方。

## 设置项与 UI 变更
- AppSettings 新增（默认都为 false，符合“默认关闭”）：
  - `enableSerpSearch`、`enableSerpBaidu`、`enableSerpBing`、`enableSerpDdg`、`searxngBaseUrl`（可选）
  - `enableCalendarTools`、`enableNotificationTools`、`enableFileTools`
- SettingsDialog 新增分区：
  - “网页搜索（SERP）”开关与 provider 开关/（可选）searxng 地址
  - “系统能力”开关（日历/通知/文件）
  - “最近动作”列表（可清空）

## 工具轮次上限调整
- 将 [ChatViewModel.kt](file:///Users/xushaoyang/Desktop/mumuchat/app/src/main/java/mumu/xsy/mumuchat/ChatViewModel.kt) 的 `MAX_TOOL_CALLS_PER_TURN` 调整为 150（或做成设置项，默认 150）。

## 测试与验收
- 解析单测：对 Baidu/（DDG 或 searxng）解析器做“给定 HTML/JSON → 提取结果断言”的纯单测。
- 手工验收：
  - `serp_search` 返回可解析 JSON（title/url/snippet），并可用 `browse_url` 精读。
  - captcha/blocked 时 `engine=auto` 自动降级。
  - 系统能力工具：每次动作有弹窗确认；拒绝/超时可追溯；动作记录可在“最近动作”看到。

## 交付顺序（尽快可用 + 风险可控）
1) 工具轮次上限改到 150。
2) 上线 `serp_search`：Baidu provider + auto/降级框架 + 短 TTL 缓存/限流。
3) 增加第二信源（DDG 或 searxng）并补齐解析单测与设置项。
4) 引入“用户确认通道 + 最近动作审计”，并在此基础上实现：日历/通知/文件导入导出工具。
5) 扩展 `get_daily_brief` 的 source（vvhan/qqsuu/770a），并给每个提供方加开关与探活/降级。
